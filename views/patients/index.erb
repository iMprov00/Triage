<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h2 mb-0">
    <i class="bi bi-people-fill text-primary me-2"></i>
    Список пациентов
  </h1>
  <a href="/patients/new" class="btn btn-primary">
    <i class="bi bi-person-plus-fill me-2"></i>
    Новый пациент
  </a>
</div>

<!-- Поиск по ФИО -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-8">
        <input type="text" 
               id="searchInput" 
               class="form-control" 
               placeholder="Поиск по ФИО (фамилия, имя, отчество)..."
               onkeyup="filterPatients()">
      </div>
      <div class="col-md-4">
        <button class="btn btn-outline-secondary" onclick="clearSearch()">
          <i class="bi bi-x-circle me-1"></i>
          Очистить
        </button>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <% if @patients.any? %>
      <!-- Информация о результатах -->
      <div class="alert alert-info mb-3 d-none" id="searchInfo">
        <i class="bi bi-info-circle me-2"></i>
        Найдено пациентов: <strong id="foundCount"><%= @patients.count %></strong>
        из <strong id="totalCount"><%= @patients.count %></strong>
      </div>

      <div class="table-responsive">
        <table class="table table-hover" id="patientsTable">
          <thead class="table-light">
            <tr>
              <th>ФИО</th>
              <th>Дата рождения</th>
              <th>Дата поступления</th>
              <th>Дата добавления</th>
              <th>Обследования</th>
              <th class="text-end">Действия</th>
            </tr>
          </thead>
          <tbody id="patientsTableBody">
            <% @patients.each do |patient| %>
              <tr class="align-middle patient-row" data-fio="<%= "#{patient.last_name.downcase} #{patient.first_name.downcase} #{patient.middle_name.to_s.downcase}" %>">
                <td>
                  <strong><%= "#{patient.last_name} #{patient.first_name} #{patient.middle_name}" %></strong>
                </td>
                <td><%= patient.birth_date.strftime('%d.%m.%Y') if patient.birth_date %></td>
                <td><%= patient.admission_date.strftime('%d.%m.%Y %H:%M') if patient.admission_date %></td>
                <td><%= patient.created_at.strftime('%d.%m.%Y %H:%M') if patient.created_at %></td>
                <td>
                  <span class="badge bg-secondary"><%= patient.assessments.count %></span>
                </td>
                <td>
                  <div class="d-flex justify-content-end gap-2">
                    <a href="/patients/<%= patient.id %>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Просмотр">
                      <i class="bi bi-eye-fill"></i>
                    </a>
                    <a href="/patients/<%= patient.id %>/edit" class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" title="Редактировать">
                      <i class="bi bi-pencil-fill"></i>
                    </a>
                    <a href="/patients/<%= patient.id %>/assessments/new" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Добавить обследование">
                      <i class="bi bi-clipboard-plus-fill"></i>
                    </a>
                    <form action="/patients/<%= patient.id %>" method="post" class="d-inline">
                      <input type="hidden" name="_method" value="delete">
                      <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Удалить" onclick="return confirm('Удалить пациента?')">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-people display-1 text-muted"></i>
        <h3 class="text-muted mt-3">Пациентов пока нет</h3>
        <p class="text-muted">Добавьте первого пациента, чтобы начать работу</p>
        <a href="/patients/new" class="btn btn-primary mt-3">
          <i class="bi bi-person-plus-fill me-2"></i>
          Добавить пациента
        </a>
      </div>
    <% end %>
  </div>
</div>

<script>
// Функция фильтрации пациентов
function filterPatients() {
  const searchText = document.getElementById('searchInput').value.toLowerCase();
  const rows = document.querySelectorAll('.patient-row');
  const searchInfo = document.getElementById('searchInfo');
  const foundCount = document.getElementById('foundCount');
  const totalCount = document.getElementById('totalCount');
  
  let visibleCount = 0;
  
  rows.forEach(row => {
    const fio = row.getAttribute('data-fio');
    const isVisible = searchText === '' || fio.includes(searchText);
    
    row.style.display = isVisible ? '' : 'none';
    if (isVisible) visibleCount++;
  });
  
  // Показываем информацию о поиске
  if (searchText !== '') {
    searchInfo.classList.remove('d-none');
    foundCount.textContent = visibleCount;
    totalCount.textContent = rows.length;
  } else {
    searchInfo.classList.add('d-none');
  }
}

// Функция очистки поиска
function clearSearch() {
  document.getElementById('searchInput').value = '';
  filterPatients();
  document.getElementById('searchInput').focus();
}

// Автофокус на поле поиска при загрузке
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('searchInput').focus();
  
  // Добавляем обработчик для быстрого поиска при вводе
  const searchInput = document.getElementById('searchInput');
  let searchTimeout;
  
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterPatients, 300); // Задержка 300ms
  });
});
</script>