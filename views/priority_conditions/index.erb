<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h2 mb-0">
    <i class="bi bi-diagram-3 text-primary me-2"></i>
    Управление условиями приоритета
  </h1>
  <a href="/admin/conditions/new" class="btn btn-primary">
    <i class="bi bi-plus-circle me-2"></i>
    Добавить условие
  </a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title">Приоритеты:</h5>
    <div class="d-flex flex-wrap gap-2">
      <% (1..5).each do |priority| %>
        <a href="#priority-<%= priority %>" class="btn btn-outline-primary">
          Приоритет <%= priority %>
          <span class="badge bg-primary ms-1">
            <%= @conditions.select { |c| c.priority_level == priority && c.active }.count %>
          </span>
        </a>
      <% end %>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <% if @conditions.any? %>
      <% (1..5).each do |priority| %>
        <h4 id="priority-<%= priority %>" class="mt-4 mb-3">
          Приоритет <%= priority %>
          <span class="badge bg-primary"><%= @conditions.select { |c| c.priority_level == priority && c.active }.count %> условий</span>
        </h4>
        
        <% priority_conditions = @conditions.select { |c| c.priority_level == priority } %>
        <% if priority_conditions.any? %>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr>
                  <th>Параметр</th>
                  <th>Оператор</th>
                  <th>Значение</th>
                  <th>Логический оператор</th>
                  <th>Позиция</th>
                  <th>Статус</th>
                  <th class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody>
                <% priority_conditions.each do |condition| %>
                  <tr>
                    <td>
                      <strong><%= condition.parameter_code %></strong>
                      <% param = @parameters.find { |p| p.code_name == condition.parameter_code } %>
                      <% if param %>
                        <br><small class="text-muted"><%= param.name %></small>
                      <% end %>
                    </td>
                    <td><code><%= condition.operator %></code></td>
                    <td><code><%= condition.value %></code></td>
                    <td>
                      <% if condition.logical_operator.present? %>
                        <span class="badge bg-info"><%= condition.logical_operator.upcase %></span>
                      <% else %>
                        <span class="badge bg-secondary">AND</span>
                      <% end %>
                    </td>
                    <td><%= condition.position %></td>
                    <td>
                      <span class="badge <%= condition.active ? 'bg-success' : 'bg-secondary' %>">
                        <%= condition.active ? 'Активно' : 'Неактивно' %>
                      </span>
                    </td>
                    <td>
                      <div class="d-flex justify-content-end gap-2">
                        <a href="/admin/conditions/<%= condition.id %>/edit" class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" title="Редактировать">
                          <i class="bi bi-pencil-fill"></i>
                        </a>
                        <form action="/admin/conditions/<%= condition.id %>" method="post" class="d-inline">
                          <input type="hidden" name="_method" value="delete">
                          <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Удалить" onclick="return confirm('Удалить условие?')">
                            <i class="bi bi-trash-fill"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Нет условий для приоритета <%= priority %>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-diagram-3 display-1 text-muted"></i>
        <h3 class="text-muted mt-3">Условий пока нет</h3>
        <p class="text-muted">Добавьте первое условие для настройки логики триажа</p>
        <a href="/admin/conditions/new" class="btn btn-primary mt-3">
          <i class="bi bi-plus-circle me-2"></i>
          Добавить условие
        </a>
      </div>
    <% end %>
  </div>
</div>